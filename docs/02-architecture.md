# 2. Архитектура

## 2.1 Общая схема

```
┌─────────────────────────────────────────────────────────────────────┐
│                           PySide6 UI                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │
│  │ Main Window │  │ CVAT Browser│  │  Editors    │                 │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                 │
└─────────┼────────────────┼────────────────┼─────────────────────────┘
          │                │                │
          │ HTTP/REST      │ HTTP           │ HTTP/REST
          ▼                ▼                ▼
┌─────────────────┐  ┌─────────────┐  ┌─────────────────┐
│   FastAPI       │  │    CVAT     │  │   FastAPI       │
│   Backend       │  │   Server    │  │   Backend       │
│   :8000         │  │   :8080     │  │   :8000         │
└────────┬────────┘  └─────────────┘  └────────┬────────┘
         │                                      │
         │ SQLAlchemy                          │ Celery
         ▼                                      ▼
┌─────────────────┐                   ┌─────────────────┐
│   PostgreSQL    │                   │     Redis       │
│   :5433         │                   │     :6380       │
└─────────────────┘                   └────────┬────────┘
                                               │
                                               ▼
                                      ┌─────────────────┐
                                      │  Celery Worker  │
                                      │  (GPU tasks)    │
                                      └────────┬────────┘
                                               │
                                               ▼
                                      ┌─────────────────┐
                                      │   ML Modules    │
                                      │  YOLO, U2-Net++ │
                                      │  Junction CNN   │
                                      └─────────────────┘
```

---

## 2.2 Компоненты

### 2.2.1 FastAPI Backend (`app/`)

Основной REST API сервер.

**Ответственность:**
- Приём и обработка HTTP запросов
- Управление жизненным циклом диаграмм
- Валидация данных
- Запуск Celery задач
- Работа с БД

**Ключевые модули:**
- `app/api/` — REST endpoints
- `app/models/` — SQLAlchemy модели
- `app/schemas/` — Pydantic схемы
- `app/services/` — бизнес-логика

### 2.2.2 Celery Worker (`worker/`)

Фоновый обработчик ML задач.

**Ответственность:**
- Выполнение ресурсоёмких ML операций
- Работа с GPU
- Обновление статусов в БД
- Создание артефактов

**Ключевые модули:**
- `worker/tasks/detection.py` — YOLO детекция
- `worker/tasks/segmentation.py` — U2-Net++ сегментация
- `worker/tasks/skeleton.py` — скелетизация
- `worker/tasks/junction.py` — классификация перекрёстков
- `worker/tasks/graph.py` — построение графа

### 2.2.3 PostgreSQL

Реляционная база данных.

**Хранит:**
- Метаданные диаграмм
- Статусы обработки
- Информацию об артефактах
- Историю этапов

**Порт:** 5433 (не 5432, чтобы не конфликтовать с CVAT)

### 2.2.4 Redis

Message broker для Celery.

**Функции:**
- Очередь задач
- Хранение результатов задач
- Pub/Sub для уведомлений (будущее)

**Порт:** 6380 (не 6379, чтобы не конфликтовать с CVAT)

### 2.2.5 CVAT

Внешний сервис для аннотации изображений.

**Функции:**
- Визуальная валидация bbox
- Редактирование аннотаций
- Экспорт в COCO формат

**Интеграция:**
- Отдельный Docker контейнер (официальный)
- Связь через REST API
- Встраивается в PySide6 через WebEngine

### 2.2.6 PySide6 UI (`ui/`)

Desktop приложение для пользователя.

**Функции:**
- Загрузка диаграмм
- Отслеживание статуса
- Встроенный CVAT браузер
- Редакторы валидации (маски, граф)
- Скачивание результатов

---

## 2.3 Потоки данных

### 2.3.1 Загрузка диаграммы

```
UI                    API                   Storage              DB
│                      │                      │                   │
│──POST /upload───────▶│                      │                   │
│   (file)             │──save file──────────▶│                   │
│                      │                      │                   │
│                      │──INSERT diagram──────────────────────────▶│
│                      │──INSERT artifact─────────────────────────▶│
│                      │                      │                   │
│◀─────{uid, status}───│                      │                   │
```

### 2.3.2 Запуск детекции

```
UI                    API                   Redis               Worker              DB
│                      │                      │                   │                   │
│──POST /detect/{uid}─▶│                      │                   │                   │
│                      │──UPDATE status───────────────────────────────────────────────▶│
│                      │──LPUSH task─────────▶│                   │                   │
│◀────{task_id}────────│                      │                   │                   │
│                      │                      │──BRPOP───────────▶│                   │
│                      │                      │                   │──YOLO inference   │
│                      │                      │                   │──save artifacts   │
│                      │                      │                   │──UPDATE status────▶│
│                      │                      │                   │──create CVAT task │
```

### 2.3.3 Polling статуса

```
UI                    API                   DB
│                      │                     │
│──GET /status/{uid}──▶│                     │
│                      │──SELECT────────────▶│
│                      │◀────{status}────────│
│◀────{status}─────────│                     │
│                      │                     │
│    (2 sec later)     │                     │
│──GET /status/{uid}──▶│                     │
│        ...           │                     │
```

---

## 2.4 Сетевая архитектура

### Docker Networks

```
┌─────────────────────────────────────────┐
│           pid_network                   │
│                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │   api   │  │ worker  │  │ postgres│ │
│  │  :8000  │  │         │  │  :5432  │ │
│  └────┬────┘  └────┬────┘  └─────────┘ │
│       │            │                    │
│       └─────┬──────┘                    │
│             │                           │
│       ┌─────┴─────┐                     │
│       │   redis   │                     │
│       │   :6379   │                     │
│       └───────────┘                     │
└─────────────────────────────────────────┘
          │
          │ (external connection)
          ▼
┌─────────────────────────────────────────┐
│        cvat_cvat (external)             │
│                                         │
│  ┌─────────────┐                        │
│  │ cvat_server │                        │
│  │    :8080    │                        │
│  └─────────────┘                        │
└─────────────────────────────────────────┘
```

### Порты

| Сервис | Внутренний | Внешний | Описание |
|--------|------------|---------|----------|
| API | 8000 | 8000 | FastAPI |
| PostgreSQL | 5432 | 5433 | БД (смещён от CVAT) |
| Redis | 6379 | 6380 | Broker (смещён от CVAT) |
| CVAT | 8080 | 8080 | Аннотация |

---

## 2.5 Безопасность

### Текущая реализация (MVP)

- CORS: разрешены все origins (`*`)
- Аутентификация: отсутствует
- CVAT: токен в `.env`

### Планируется (Production)

- JWT аутентификация
- HTTPS
- Ограничение CORS
- Rate limiting
- Audit logging

---

## 2.6 Масштабирование

### Горизонтальное масштабирование

```yaml
# docker-compose.override.yml
services:
  worker:
    deploy:
      replicas: 3  # Несколько GPU workers
```

### Вертикальное масштабирование

- Увеличение `worker_concurrency` в Celery
- Увеличение `pool_size` в SQLAlchemy
- Больше памяти для GPU workers

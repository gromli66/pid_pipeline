# 1. Обзор проекта

## 1.1 Что это?

**P&ID Pipeline** — приложение для автоматической обработки P&ID (Piping and Instrumentation Diagrams) диаграмм с использованием компьютерного зрения и машинного обучения.

Приложение позволяет:
- Автоматически распознавать оборудование на технологических схемах
- Валидировать результаты распознавания через CVAT
- Строить топологический граф схемы
- Экспортировать результаты в FXML для интеграции с JavaFX приложениями

---

## 1.2 Основные возможности

| # | Этап | Технология | Описание |
|---|------|------------|----------|
| 1 | Детекция узлов | YOLO + SAHI | Находит оборудование: клапаны, насосы, датчики и т.д. |
| 2 | Валидация bbox | CVAT | Инженер проверяет и корректирует детекции |
| 3 | Сегментация труб | U2-Net++ | Выделяет трубопроводы на схеме |
| 4 | Скелетизация | OpenCV | Построение центральных линий труб |
| 5 | Классификация перекрёстков | CNN | Определяет соединения и мосты (пересечения без соединения) |
| 6 | Валидация масок | PySide6 | Инженер корректирует маски труб и перекрёстков |
| 7 | Построение графа | NetworkX | Создание топологии схемы |
| 8 | Генерация FXML | Custom | Экспорт для JavaFX приложений |

---

## 1.3 Пайплайн обработки

```
┌─────────────────┐
│   ИЗОБРАЖЕНИЕ   │
│   (PNG/JPG)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  [1] YOLO       │────▶│  CVAT           │
│  Детекция       │     │  Валидация      │
└────────┬────────┘     └────────┬────────┘
         │                       │
         │◀──────────────────────┘
         │  yolo_validated.txt
         │  coco_validated.json
         ▼
┌─────────────────┐
│  [2] U2-Net++   │
│  Сегментация    │
└────────┬────────┘
         │  pipe_mask.png
         ▼
┌─────────────────┐
│  [3] Skeleton   │
│  Скелетизация   │
└────────┬────────┘
         │  skeleton.png
         ▼
┌─────────────────┐
│  [4] Junction   │
│  CNN            │
└────────┬────────┘
         │  junction_mask.png
         │  bridge_mask.png
         ▼
┌─────────────────┐
│  [5] PySide6    │
│  Валидация      │
│  масок          │
└────────┬────────┘
         │  validated_*.png
         ▼
┌─────────────────┐
│  [5.1] Simple   │
│  Skeleton       │
└────────┬────────┘
         │  final_skeleton.png
         ▼
┌─────────────────┐
│  [6] Graph      │
│  Builder        │
└────────┬────────┘
         │  graph.json
         ▼
┌─────────────────┐
│  [7] PySide6    │
│  Валидация      │
│  графа          │
└────────┬────────┘
         │  validated_graph.json
         ▼
┌─────────────────┐
│  [8] FXML       │
│  Generator      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   output.fxml   │
└─────────────────┘
```

---

## 1.4 Статусы диаграммы

Каждая диаграмма проходит через последовательность статусов:

```
uploaded                    # Загружена
    ↓
detecting → detected        # YOLO детекция
    ↓
validating_bbox → validated_bbox    # CVAT валидация
    ↓
segmenting → segmented      # U2-Net++ сегментация
    ↓
skeletonizing → skeletonized    # Скелетизация
    ↓
classifying_junctions → classified  # Junction CNN
    ↓
validating_masks → validated_masks  # PySide6 валидация
    ↓
building_graph → built      # Построение графа
    ↓
validating_graph → validated_graph  # PySide6 валидация
    ↓
generating_fxml → completed # Генерация FXML
```

При ошибке на любом этапе статус меняется на `error` с сохранением `error_stage` для возможности retry.

---

## 1.5 Сохраняемые артефакты

Для дообучения моделей сохраняются:

| Этап | Артефакт | Формат | Назначение |
|------|----------|--------|------------|
| CVAT валидация | `yolo_validated.txt` | YOLO | Дообучение YOLO |
| CVAT валидация | `coco_validated.json` | COCO | Дообучение YOLO |
| Валидация масок | `validated_pipe_mask.png` | PNG binary | Дообучение U2-Net++ |
| Валидация масок | `validated_junction_mask.png` | PNG binary | Дообучение Junction CNN |
| Валидация масок | `validated_bridge_mask.png` | PNG binary | Дообучение Junction CNN |
| Валидация графа | `validated_graph.json` | JSON | Тестирование графовых нейросетей |

---

## 1.6 Технологический стек

### Backend
- **FastAPI** — REST API
- **Celery** — фоновые задачи (ML inference)
- **PostgreSQL** — база данных
- **Redis** — message broker для Celery

### ML модули
- **YOLO** (ultralytics) — детекция объектов
- **SAHI** — inference на больших изображениях
- **U2-Net++** — сегментация
- **PyTorch** — deep learning framework

### Frontend
- **PySide6** — desktop UI
- **CVAT** — веб-интерфейс для аннотации

### DevOps
- **Docker** — контейнеризация
- **Docker Compose** — оркестрация
- **Alembic** — миграции БД
